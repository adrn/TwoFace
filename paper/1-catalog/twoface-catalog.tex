\documentclass[modern, letterpaper]{aastex62}

% to-do list
% ----------
% - write a first draft of the introduction
% - list our assumptions for detection & characterization (TheJoker)
% - Check abstract numbers (~80,000 RG stars with 3 or more good visits?)

% style notes
% -----------
% - This file generates by Makefile; don't be typing ``pdflatex'' or some BS.
% - Line break between sentences to make the git diffs readable.
% - Use \, as a multiply operator.
% - Reserve () for function arguments; use [] or {} for outer shit.
% - Always prior pdf or posterior pdf, never prior or posterior (that's your
%   arse).
% - Use \sectionname not Section, \figname not Figure, \documentname not Article
%   \tablename not Table, \eqname not Equation.
% - Make sure that two assumptions in the two assumption lists only have the
%   same name if they really are the same assumption: These are proper names!
% - Hyphenate binary-star when it is an adjective, not when it is a noun!
% - Where there are defined math symbols (like \pars), use them!

% other notes
% -----------
% - Binary engulfment reference: https://arxiv.org/pdf/1002.2216.pdf

\include{gitstuff}
\include{preamble}

% adjust AAS-TEX shit
% \setlength{\parindent}{1.1\baselineskip}

\graphicspath{{figures/}}

% define macros for text
\newcommand{\apogee}{\project{\acronym{APOGEE}}}
\newcommand{\sdssiv}{\project{\acronym{SDSS-IV}}}
\newcommand{\thejoker}{\project{The~Joker}}
\newcommand{\thecannon}{\project{The~Cannon}}
\newcommand{\DR}{\acronym{DR14}}
\newcommand{\RC}{\acronym{RC}}
\newcommand{\RGB}{\acronym{RGB}}

\newcommand{\nprior}{536,870,912}
\newcommand{\nposterior}{256}
\newcommand{\nstars}{98,758}
\newcommand{\nvisits}{388,196}

% for response to referee
% \renewcommand{\resp}[1]{#1}

\shortauthors{Price-Whelan et al.}

\begin{document}\sloppy\sloppypar\raggedbottom\frenchspacing % trust me

\title{Binary companions of red giant stars with APOGEE: \\
       catalog and companions that survive the common envelope}

\author[0000-0003-0872-7098]{Adrian~M.~Price-Whelan}
\affiliation{Department of Astrophysical Sciences,
             Princeton University, Princeton, NJ 08544, USA}
\email{adrn@astro.princeton.edu}
\correspondingauthor{Adrian M. Price-Whelan}

\author[0000-0003-2866-9403]{David~W.~Hogg}
\affiliation{Max-Planck-Institut f\"ur Astronomie,
             K\"onigstuhl 17, D-69117 Heidelberg, Germany}
\affiliation{Center for Cosmology and Particle Physics,
             Department of Physics,
             New York University, 726 Broadway,
             New York, NY 10003, USA}
\affiliation{Center for Data Science,
             New York University, 60 Fifth Ave,
             New York, NY 10011, USA}
\affiliation{Flatiron Institute,
             Simons Foundation,
             162 Fifth Avenue,
             New York, NY 10010, USA}

\author{Hans-Walter~Rix}
\affiliation{Max-Planck-Institut f\"ur Astronomie,
             K\"onigstuhl 17, D-69117 Heidelberg, Germany}

% \author{Jason~Cao}
% \affiliation{Center for Cosmology and Particle Physics,
%              Department of Physics,
%              New York University, 726 Broadway,
%              New York, NY 10003, USA}

\begin{abstract}\noindent % trust me
% Context
Repeat radial-velocity measurements of stars can be used to identify stellar-,
sub-stellar, and planetary-mass companions.
Even few observations are useful for detecting companions, though such data are
difficult to use for constraining physical properties because permitted orbital
solutions are highly degenerate.
% Aims
Here we perform a search for secondary companions of stars observed by the
\apogee\ survey (\DR), which has measured multi-epoch ($\geq 3$) but sparse
radial velocities for close to 100,000 stars.
% Methods
We use a custom-built Monte Carlo sampler (\thejoker) to deliver (often highly
multi-modal) posterior beliefs about companion orbital parameters.
In some cases, where the primary-star masses are known, the mass-function
degeneracy is broken and the secondary-companion masses ($m_2\,\sin i$) can be
inferred.
% Results
We provide a catalog of \ncompanions\ companions for which the companion
properties can be confidently determined, along with posterior samplings for all
\ntotal\ stars in the parent sample.
\todo{We find differences between the companions around \RC\ and \RGB\
stars that are in/consistent with the theoretical prediction that
stellar companions should not survive the common-envelope \RGB\ phase.}
\todo{We additionally find trends in XX with chemical abundances.}

We compare the companion populations of red clump (\RC) versus \RGB\ stars at
similar surface gravity and temperature, and study the metallicity dependence
of companion properties.

\end{abstract}

\keywords{
  binaries:~spectroscopic
  ---
  methods:~data~analysis
  ---
  methods:~statistical
  ---
  planets~and~satellites:~fundamental~parameters
  ---
  surveys
  ---
  techniques:~radial~velocities
}

\section{Introduction} \label{sec:intro}

\todo{Intro is missing many citations}

Stars typically have companions. Main sequence stars in the solar neighborhood
more often appear in binary or multiple star systems rather than as solitary
stars (e.g., \citealt{Duquennoy:1991,Raghavan:2010,Tokovinin:2014}).
This is likely a generic outcome of star formation: For example, turbulent
fragmentation in collapsing protostellar clouds can produce stellar multiplets
within length-scales comparable to their spheres of influence (e.g.,
\citealt{Raskutti:2016}).
Binary and multiple star systems are therefore of great interest in
astrophysics: The population of stars and their companions encodes information
about star formation processes, stellar parameters and evolution, and the
dynamics of multi-body systems (for recent reviews, see
\citealt{Duchene:2013,Moe:2017}).

% Even without stellar or sub-stellar companions, the vast majority of stars have
% planetary-mass companions (\citealt{todo}).
% \todo{Planetary systems are interesting because...blah}
% Differences between the population of stellar companions and that of
% planetary-mass companions likely relate directly to the different formation
% channels for these objects.

Most of what is known about stellar companions comes from studies of
main-sequence (MS) stars.
MS stars with companions have a large dynamic range of constituent and orbital
characteristics.
For example, binary stars have mass-ratios that span from $\approx 10^-3$
\todo{citation because this is made up} to 1, and have periods from days to
millions of years.
\todo{Describe distributions over these quantities}
\todo{multiplicity in general: abundance, numbers, etc.}
\todo{some other stats from Moe and Di Stefano}

Some evolved stars have special roles in well-studied exotic multiple systems
like dwarf novae or cataclysmic variables \todo{are those examples correct?},
but by-in-large, less is known about the population of companions to evolved
stars.

- Expect differences in evolved star pop. from main sequence populations:
  - mass loss
  - envelope -> engulfment?
- Current samples limited in dynamical range of chemical properties, location,
  age (local to sun)
- Brighter, but typically larger distances, direct imaging not feasible
- Eclipsing companions good, but low mass companions stars -> hard to find
  (giants are big)
- Need large sample of stars with time-domain spectroscopy

% For planetary companions of main sequence stars, \todo{}.
% - Some indication of trends (e.g., with metallicity) -> star and
%   planet formation processes

Time-domain radial-velocity measurements of stars contain information about
massive companions: even with two successive observations of a single star, a
difference in the measured radial velocities implies the existence of at least
one companion.
However, with few or imprecise radial-velocity measurements, the orbital
properties of the companion(s) are very poorly constrained (e.g.,
\citealt{Price-Whelan:2017}).
The vast majority of spectroscopic targets with repeat observations in the
largest (by number of objects) stellar spectroscopic surveys are often observed
just a few times with sparse, non-uniform phase coverage.
Most prior searches for companions using survey RV data have therefore
restricted their searches to only sources with many, high-precision epochs, so
that the orbital solution can be unambiguously determined (e.g.,
\citealt{Troup:2016}), or have used simple statistics computed from the data to
study multiplicity (e.g., $\textrm{RV}_\textrm{max} - \textrm{RV}_\textrm{min}$;
\citealt{Badenes:2017}).

If there are only a few radial-velocity measurements made per star, and the
companion spectrum is not observed, any measured radial-velocity values will be
consistent with many different combinations of (primary) orbital parameters
(period, amplitude, eccentricity, etc.).
To identify companions to the typical star observed in a spectroscopic survey,
we therefore face at least one major challenge: how, given a small number of
observations of a primary star, do we reliably obtain posterior information
about the binary-system properties?
In general, the likelihood function---and the posterior probability distribution
function (pdf) under any reasonable prior pdf---will be highly multimodal, and
many of the modes will have comparable integrated probability density.
For example, with just two radial-velocity measurements, a harmonic series of
period modes will exist in the likelihood function.

We have solved this problem previously, though with limitations (to be discussed
more below), with \thejoker\ (\citealt{Price-Whelan:2017}).
\thejoker\ is a Monte Carlo rejection sampler that is computationally expensive
but probabilistically righteous:
It delivers independent posterior pdf samples for single-companion binary
orbital parameters, given any number of radial-velocity measurements.
Here we use \thejoker\ to generate posterior pdf samples for stars observed by
the \apogee\ survey (see \sectionname~\ref{sec:data}; \citealt{Majewski:2015}).

The \apogee\ surveys primarily target red-giant-branch (\RGB) stars, which are
ideal for the study of single-line binary systems.
For one, because they are so luminous, they are unlikely (in general) to have
equally-bright companions, and their spectra are therefore well-approximated or
fit as single-line objects.
When this constraint is not met, \thejoker\ will in general fail, and a model
that fits for a mixture of stellar spectra is more appropriate (e.g.,
\citealt{Kareem}).
The subset of \RGB\ stars in the ``red clump'' (\RC) are even more powerful as
they are standard candles and have masses that can be estimated using
spectroscopy (using dredged-up elements; \citealt{Martig:2016,Ness:2016}).
With primary-star mass estimates, the binary-orbit fitting will return
$m_2\,\sin i$ (minimum mass) estimates for the secondary, and not just estimates
of the so-called ``binary mass function.''
Additionally, the \apogee\ pipelines (\citealt{Garcia-Perez:2016}) and also
\thecannon\ (\citealt{Ness:2015}) produce detailed abundance estimates for \RGB\
and \RC\ stars.
If there are causal relationships between chemical abundances and binary
companions---as are expected---these should be measurable.

By making cuts on this library of posterior pdf samples (described in detail in
\sectionname~\ref{sec:whatever}), we deliver a catalog of binary-star systems
from the \apogee\ survey \todo{with ... (tease some statistics)}.
We additionally highlight the subset of this catalog with \RC\ star primaries,
for which we can compute companion mass and pericentric distance.

\section{Data} \label{sec:data}

All data used in this work comes from the publicly-available data release 14
(\DR) of the \apogee\ survey (\citealt{apogeedr14}), a component of the Sloan
Digital Sky Survey IV (\sdssiv; \citealt{sdss,Blanton:2017}).
\apogee\ is designed to map stars across much of the Milky Way by obtaining
high-resolution ($R \sim 22500$) infrared ($H$-band) spectroscopy of primarily
\RGB\ stars.
Targets are selected with simple color and brightness cuts, but the survey uses
fiber-plugged plates with a maximum of 300 fibers per each $\approx
1.5~\textrm{deg}^2$ field of view, leading to ``pencil-beam''-like sampling of
the stellar distribution.
Data taken as part of the \apogee\ survey is reduced with the \apogee\ Stellar
Parameters and Chemical Abundances Pipeline (\acronym{ASPCAP};
\citealt{Garcia-Perez:2016}), which measures stellar parameters, chemical
abundances, and radial velocities for each target.
In order to meet signal-to-noise ratio requirements, most \apogee\ stars are
observed multiple times in a series of ``visits,'' typically with at least one
visit separated by a month or more in order to help identify binary stars.
\acronym{ASPCAP} iteratively solves for the relative velocities of each visit
spectrum while determining the optimal co-addition of the visit spectra.

We use the primary data products from \apogee\ \DR\ (i.e. the \texttt{allStar}
and \texttt{allVisit} files) which contain 258,475 unique source IDs
(\texttt{APOGEE\_ID}) and 1,054,381 unique visits.
We select all stars with $\geq 3$ visits that each pass a set of quality cuts,
described below.
For each visit, we require that the visit velocity uncertainty is $< 100~\kms$
(\texttt{VRELERR}) and the following bits are not set in the \texttt{STARFLAGS}
bitmask: \texttt{PERSIST\_HIGH}, \texttt{PERSIST\_JUMP\_POS},
\texttt{PERSIST\_JUMP\_NEG}, \texttt{VERY\_BRIGHT\_NEIGHBOR}, \texttt{LOW\_SNR}.
For each star, we require that $0 < \log g < 3.5$ and the following bits are not
set in the \texttt{ASPCAPFLAGS} bitmask: \texttt{STAR\_BAD}.
After these cuts, and the requirement of $\geq 3$ visits for a given star, we
are left with \nvisits\ visits for \nstars\ unique sources.
\figurename~\ref{fig:nvisits} shows the number of stars in several bins of
number of visits that pass the above quality cuts: \todo{XX}\% of the stars in
\DR\ have $< 8$ visits.

% Notebook: "Numbers after cuts"
\begin{figure}[h]
\begin{center}
\includegraphics[width=0.7\textwidth]{nvisits.pdf}
\end{center}
\caption{%
\todo{Update with new apogee db file}
Number of \apogee\ stars in logarithmic bins of number of visits that pass the
quality cuts described in \sectionname~\ref{sec:data}.
In total, this work uses \nvisits\ visits and \nstars\ unique sources.
\label{fig:nvisits}
}
\end{figure}


\section{Methods}

\subsection{Orbit inference and velocity modeling}\label{sec:fitting}

For every source in the sample of \apogee\ stars defined in
\sectionname~\ref{sec:data}, we obtain a posterior sampling in binary-system
parameter space, treating it as a single-lined (SB1) spectroscopic binary system
with a single companion.
This sampling is performed under a relatively uninformative prior pdf, and the
resulting posterior samplings are used to discover and characterize individual
binary-star systems and generate a catalog of companions.
We use \thejoker\ to perform the posterior samplings; we briefly describe the
algorithm below, but a full description is given in previous work
(\citealt{Price-Whelan:2017}).
In this \sectionname, we describe the assumptions and method used to generate
individual-system samplings.

We perform our individual system fits---that is, make our posterior
samplings---under the following assumptions:
\begin{description}
\item[no multiplets] All radial-velocity variations of the primary star are
  induced by a single companion.
  This is motivated by the idea that triple star systems are usually
  hierarchical so that the period of the inner binary is typically much shorter
  than the orbital period of the outer body (\todo{CITATION NEEDED}).
  At present, we ignore the possibility of higher-order multiple systems.
  % \todo{revisit this - do we want to also sample over a long-term trend?}
\item[Kepler] Related to the first point, all velocity variations of the primary
  are gravitational, and we therefore ignore the possibility of coherent intrinsic variation from, e.g., stellar oscillations.
\item[SB1] All spectra are single-lined; that is, we assume that the secondary
  is significantly fainter and is thus undetected in the spectra.
  This assumption is motivated by the fact that we expect \RGB\ stars to be
  substantially more luminous than their typical companion.
  However, there are known double-lined binary stars in the \apogee\ catalog
  \citealt{El-Badry:2017}, and an expected but unknown fraction of \RGB--\RGB\
  binaries.
\item[simple noise model] Measurements are unbiased and noise estimates are
  correct up to an unknown extra variance.
  All noise contributions result in Gaussian uncertainties on the individual
  radial-velocity measurements.
  We often refer to the extra variance as a ``jitter'' parameter because for
  upper \RGB\ stars the inferred extra variance will be a combination of extra
  uncertainty and true astrophysical surface jitter (\todo{CITATION NEEDED}).
\end{description}

\thejoker\ is a custom-built Monte Carlo sampler designed to produce independent
posterior samples in Keplerian orbital parameters, given radial-velocity
measurements under the assumptions listed above.
Our parametrization of the orbital elements is similar to the notation in
\citet{Murray:2010}:
The radial velocity $v$ at time $t$ is given by
\begin{equation}
  v(t;\bs{\theta}) = v_0 + K\,[\cos\left(\omega + f(t; e, P, M_0)\right) +
    e\,\cos\omega]
\end{equation}
where $\bs{\theta} = (P,e,M_0,\omega,K,v_0)$---period, eccentricity, mean
anomaly at a reference time $t_0$, argument of pericenter, velocity
semi-amplitude, Barycentric velocity---and the true anomaly, $f$, is a function
of time and the specified parameters (see \sectionname~2 of
\citealt{Price-Whelan:2017} or \eqname~63 in \citealt{Murray:2010}).

\thejoker\ was designed for the extremely multi-modal pdfs expected when the
number of radial-velocity measurements of a source is small, or the data are
sparse (in phase-coverage) or noisy.
While other Markov Chain Monte Carlo (MCMC) methods have difficulty producing
independent samples with such data, \thejoker\ succeeds by brute force:
After generating an initial (very large) library of prior samples from an
assumed prior pdf (see below), the (typically multi-modal) likelihood is
evaluated at each sample and used to rejection sample.
In practice, given a number of requested samples for each star, the sampling
proceeds iteratively: since it is easier to accept samples when the data is
sparse or noisy, far more prior sample draws (and thus likelihood evaluations)
must occur under very constraining data.

\subsection{Model selection}

In addition to generating posterior samples for each source, we also compute the
fully marginalized likelihood (FML) under two other models: (1) a model in which
the radial velocity of the source is constant, and (2) a model in which the
radial-velocity variations are purely linear.
We later use these FML values to define cuts on our full catalog of posterior
samples to produce a catalog of companions.

\todo{equations?}

Examples of outputs and etc.

\section{Results}

\subsection{Initial inidivual-system posterior samplings}
\label{sec:initsampling}

For all \nstars\ \apogee\ stars with $\geq 3$ good visits (see
\sectionname~\ref{sec:data}), we use \thejoker\ to generate posterior samplings
for each star under the assumptions listed above (see
\sectionname~\ref{sec:fitting}).
We start by generating a library of \nprior\ prior samples generated under a
prior similar to that defined in \citet{Price-Whelan:2017}: uniform or isotropic
in angle parameters, uniform in log-period over the domain $[1,
32768]~\textrm{day}$, and a beta distribution over eccentricity with fixed
parameters (\citealt{Kipping:2013}).
For the prior over the extra variance or jitter parameter, $s$, we initially use
a Gaussian over the transformed parameter $y = \ln s^2$ with the mean and
standard deviation of the initial distribution set to $(\mu_{y,0}, \sigma_{y,0})
= (10.6, 3)$ in units of $\textrm{m}~\textrm{s}^{-1}$.

We request \nposterior\ posterior samples for each source, and generate the
samples using an iterative procedure that adapts to the \todo{informativeness}
of the data to more efficiently generate posterior samples.
For sources with very constraining data, \thejoker\ may return fewer than the
requested number of samples.
When this happens, we proceed in one of two ways:
\begin{enumerate}
    \item \emph{needs MCMC}: If just 1 posterior sample is returned after
    exhausting the full library of prior samples, or if multiple (but fewer than
    \nposterior) are returned that all lie within a single mode of the posterior
    pdf, the orbit-space that is consistent with the data is treated as
    effectively unimodal. In this case, we use the location of the returned
    sample, or the median over returned samples to generate a small ball of
    initial conditions and use standard MCMC to continue sampling until we obtain \nposterior\ samples. In detail, we use an ensemble sampler
    (\citealt{Goodman:}) implemented in \python\ (\citealt{Foreman-Mackey:}),
    run with \todo{XX} walkers for \todo{XX} steps, and downsample the resulting
    MCMC chains until we have \nposterior\ samples.
    \item \emph{needs more prior samples}: If more than 1 posterior sample is
    returned after exhausting the full library of prior samples and the samples
    lie in multiple modes of the posterior pdf, the star is flagged. In this
    case, the only way to proceed is to generate more prior samples and continue
    running \thejoker\ for these sources to generate more posterior samples.
\end{description}

A full run of \thejoker\ on all \nstars\ \apogee\ stars used in this work took
approximately 300 hours on a compute cluster with 448 cores, with the time
dominated by sources with many ($\gtrsim 10$) visits.


\subsection{Inferring the extra variance distribution}
\label{sec:inferjitter}

As an initial use of the per-source posterior samplings, we use a hierarchical
Bayesian model to infer the parameters of the (assumed Gaussian) distribution
over the log-jitter parameter: $(\mu_y, \sigma_y)$.
This inference serves as a test-case for future work, where we intend to use the
independent posterior samplings to construct a hierarchical inference over
companion property distributions.
This is also a test of the visit velocity uncertainties reported in the \apogee\
data products: If the catalog uncertainties are significantly underestimated, we
expect the inferred log-jitter distribution parameters to tend towards larger
values.

In detail, we maximize the marginal likelihood of the population-level
parameters $\bs{\alpha} = (\mu_y, \sigma_y)$.
We compute this marginal likelihood using the per-object posterior samples
re-weighted by the ratio of the value of the hyperprior evaluated at a given
vector $\bs{\alpha}$ over the value of the default prior at the previously
assumed values, $\bs{\alpha}_0 = (\mu_{y,0}, \sigma_{y,0})$ (see
\sectionname~\ref{sec:initsampling}).
This trick has been used in other hierarchical inferences as a way to
marginalize over the per-object parameters
(\citealt{Hogg:2008,Foreman-Mackey:...}); we describe how to compute the
marginal likelihood in detail below.

For each $n$ of $N$ RGB stars in APOGEE, we obtain $K$ posterior samples over
primary orbital parameters $\bs{\theta} = (P, e, \omega, M_0, K, v_0)$ and the
jitter parameter, $y = \ln s^2$, using \thejoker; For brevity in expressions
below, we will use the vector
\begin{equation}
    \bs{w} = (\bs{\theta}, y)
\end{equation}
to represent the full set of parameters.
To obtain this sampling, we use an interim (Gaussian) prior on the jitter
parameter parametrized by a mean and standard deviation, i.e. $\alpha_0 =
(\mu_{y,0}, \sigma_{y,0})$ as described above.
For a given source, the posterior samples in the above parameters are drawn from
the distribution
\begin{equation}
    \bs{w}_k \sim p(\bs{w}_k \given D, \bs{\alpha}_0)
\end{equation}
where $D$ represents the data for a given object.

We want to compute the likelihood of all data from all $N$ stars, $\{D_n\}$,
given a new set of hyperparameters $\bs{\alpha}$
\begin{equation}
    p(\{D_n\} \given \bs{\alpha}) = \prod_n^N p(D_n \given \bs{\alpha})
\end{equation}
where in the above, we have assumed that this likelihood is separable ( the data
for each source are independent).
The per-source marginal likelihood in the above expression is given by
\begin{align}
    p(D_n \given \bs{\alpha}) &= \int \dd \bs{w}_n \, p(D_n \given \bs{w}_n) \,
      p(\bs{w}_n \given \bs{\alpha})\\
    &= \int \dd \bs{w}_n \, p(D_n \given \bs{w}_n) \, p(\bs{w}_n \given \bs{\alpha}) \,
      \frac{p(\bs{w}_n \given D_n, \bs{\alpha}_0)}{p(\bs{w}_n \given D_n, \bs{\alpha}_0)}\\
    &= p(D_n \given \bs{\alpha}_0) \, \int \dd \bs{w}_n \,
      \frac{p(\bs{w}_n \given \bs{\alpha})}{p(\bs{w}_n \given \bs{\alpha}_0)} \,
      p(\bs{w}_n \given D_n, \bs{\alpha}_0) \label{eq:marglike} \quad .
\end{align}
Using the Monte Carlo integration approximation, \eqname~\ref{eq:marglike} can
be simplified to a sum over prior value ratios of the $K$ posterior samples in
the log-jitter parameter for each $n$ star
\begin{equation}
    \approx \frac{\mathcal{Z}_n}{K} \,
      \sum_k^{K} \frac{p(y_{nk} \given \bs{\alpha})}{p(y_{nk} \given \bs{\alpha}_0)}
\end{equation}
where we have canceled the other priors (over $\bs{\theta}$), and all
normalization constants appear in the constant scale factor $\mathcal{Z}_n$.

The above expresion gives the marginal likelihood of the velocity data for a single source given new hyperparameters $\bs{\alpha}$.
The full marginal likelihood is then the product of these individual likelihoods
\begin{align}
    p(\{D_n\} \given \alpha) &\propto \prod_n^N \frac{1}{K} \,
      \sum_k^{K} \frac{p(y_{nk} \given \alpha)}{p(y_{nk} \given \alpha_0)}
      \quad .
\end{align}
In practice, we evaluate the log-marginal-likelihood
\begin{align}
    \ln p(\{D_n\} \given \alpha) &\propto \sum_n^N \left[
      \ln\left( \sum_k^{K} \frac{p(y_{nk} \given \alpha)}{p(y_{nk} \given \alpha_0)} \right)
      - \ln K\right]\label{eq:lnlike}\\
    &\propto \sum_n^N \left[
      \underset{k}{\textrm{logsumexp}}\left[ \ln{p(y_{nk} \given \alpha)} - \ln{p(y_{nk} \given \alpha_0)} \right]
      - \ln K\right]
\end{align}
where $\textrm{logsumexp}$ (the log-sum-exp trick) provides a more stable
estimate of the sum in \eqname~\ref{eq:lnlike}.

We use 1,825 stars with $>10$ visits and $\log g < 2$ (to avoid upper RGB stars
that have large intrinsic jitter) and maximize the above likelihood to determine
better hyperparameters for the log-jitter parameter distribution.
\figurename~\ref{fig:infer-jitter} shows the distribution corresponding to the
maximum-likelihood hyperparameters, $\alpha^* = (\mu_y^*, \sigma_y^*) = (9.50,
1.64)$.
\todo{discussion about this}
\todo{some discussion of how this relates to empirical bayes?}

% Notebook: "Infer jitter"
\begin{figure}[h]
\begin{center}
\includegraphics[width=\textwidth]{infer-jitter}
\end{center}
\caption{%
\todo{move notebook to figures path, re-do with "run2" or "run1" samples...}
Inferred prior over log-jitter parameter ($y = \ln s^2$) using posterior samples
for 1,825 lower-RGB stars with $>10$ visits.
Left panel shows the ... Right panel shows the ...
\label{fig:infer-jitter}
}
\end{figure}

\subsection{Catalog of posterior samplings for APOGEE DR14 RGB stars}
\label{sec:fullcatalog}

TODO: re-do exactly \sectionname~\ref{sec:initsampling}, but with $(\mu_{y}, \sigma_{y}) = (9.5, 1.6)$ again in units of ${\rm m}~{\rm s}^{-1}$.

TODO: how many hit each category (flag) after the initial run

\subsection{A catalog of confident companions} \label{sec:conf-companions}

\todo{APW}

Thresholding on what now?

Catalog.

Some highlights from this catalog.

\subsection{Differences in companions of RC and RGB stars}
\label{sec:rc-rgb}

\todo{APW}

\subsection{Trends in RGB companions with chemical abundances}
\label{sec:rgb-chemistry}

\todo{APW}

\section{Discussion}

Return to our various assumptions and make sure that we discuss them
\emph{by name} here.

\acknowledgements

It is a pleasure to thank Keith Hawkins (Columbia), XXXXXXX.

The authors are pleased to acknowledge that the work reported on in this
paper was substantially performed at the TIGRESS high performance computer
center at Princeton University which is jointly supported by the Princeton
Institute for Computational Science and Engineering and the Princeton
University Office of Information Technology's Research Computing department.

\software{
The code used in this project is available from
\url{https://github.com/adrn/TwoFace} under the MIT open-source
software license.
This research utilized the following open-source \python\ packages:
    \package{Astropy} (\citealt{Astropy-Collaboration:2013}),
    % \package{corner} (\citealt{Foreman-Mackey:2016}),
    % \package{emcee} (\citealt{Foreman-Mackey:2013ascl}),
    \package{IPython} (\citealt{Perez:2007}),
    \package{matplotlib} (\citealt{Hunter:2007}),
    \package{numpy} (\citealt{Van-der-Walt:2011}),
    \package{scipy} (\url{https://www.scipy.org/}),
    \package{sqlalchemy} (\url{https://www.sqlalchemy.org/}).
}

\facility{\sdssiii, \apogee}

\bibliographystyle{aasjournal}
\bibliography{refs}

\end{document}
